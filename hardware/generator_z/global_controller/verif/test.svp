/* *****************************************************************************
 * File: test.v
 * Author: Ofer Shacham
 * 
 * Description:
 * simple test bench for template
 * 
 *
 * Change bar:
 * -----------
 * Date          Author   Description
 * Apr 3, 2010  shacham  initial version
 *  
 * 
 * ****************************************************************************/

////////////////////////////// IMPORTANT MESSAGE: //////////////////////////////
// Note that programs are written using object oriented programming. They
// are closer to software than to hardware. There is therefore no real need
// in a genesis type parameterization.
////////////////////////////////////////////////////////////////////////////////

program automatic `mname`(interface ifc);
   
   // some variables to control the test
   int                           seed;
   int                           rnd0;
   int 				 fd;
   
   // Instantiate a jtag driver
   //; my $jtag_drvr_obj = generate_base('JTAGDriver', 'jdrv');
   `$jtag_drvr_obj->instantiate`;
   jtag_regfile_trans_t jtag_trans;      
   task run_test;
      begin
	 jdrv.ReadID(jtag_trans);
	 
	 // initialization of structs:
	 jtag_trans.domain = sc_domain;
	 jtag_trans.addr = 32'd1;
	 jtag_trans.op = write;
	 jtag_trans.data_out = '0;
	 

	 @(posedge ifc.Clk);
	 jtag_trans.data_in = 32'd25;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 1 (Write):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 
         check_config_write(jtag_trans.addr,jtag_trans.data_in); 


	 @(posedge ifc.Clk);
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jtag_trans.op = read;
	 ifc.config_data_from_gc = 32'd88;
	 jdrv.Send(jtag_trans);
	 check_config_read(jtag_trans.addr);
	 jtag_trans = jdrv.GetResult();
	 assert(jtag_trans.data_out == top.dut.config_data_in);
	 $fdisplay(fd,"%t: %m: Trans 2 (Read):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 
	 
         @(posedge ifc.Clk);
	 jtag_trans.op = wr_delay_sel_reg;
	 jtag_trans.data_in = 32'b01;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 check_register(top.dut.delay_sel, jtag_trans.data_in);
         //TODO: check that delay_sel reg actually works, beyond being able to read and write to it
	 
	 @(posedge ifc.Clk);
	 ifc.config_data_from_gc = 32'd999;
         jtag_trans.addr=32'd300;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
         jtag_trans.op = read;
	 jdrv.Send(jtag_trans);
         check_config_read(jtag_trans.addr);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 3 (Read):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
         assert(jtag_trans.data_out == top.dut.config_data_in);

	
	 @(posedge ifc.Clk);
	 jtag_trans.op = switch_clk;
	 jtag_trans.data_in = 1;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 4 (sys_clk_switch):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 check_register(top.dut.clk_switch_request,jtag_trans.data_in);
	 repeat(100) @(posedge top.dut.tck);
         //Now check clk out and 
         repeat(200) begin
            @(posedge ifc.Clk);
            assert(top.dut.clk_out == top.dut.clk_in); //make sure we've actually switched to the fast clk;
         end
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = read_clk_domain;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 3 (Read clk domain):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 check_register(top.dut.clk_switch_request,jtag_trans.data_out);

	 @(posedge ifc.Clk);
	 jtag_trans.op = switch_clk;
	 jtag_trans.data_in = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 4 (sys_clk_switch):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 check_register(top.dut.clk_switch_request,jtag_trans.data_in);
	 repeat(100) @(posedge top.dut.tck);
         //Now check clk out and 
         repeat(200) begin
            @(posedge ifc.Clk);
            assert(top.dut.clk_out == top.dut.tck); //make sure we've actually switched to the slow clk;
         end
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = read_clk_domain;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 3 (Read clk domain):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 check_register(top.dut.clk_switch_request,jtag_trans.data_out);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = wr_delay_sel_reg;
	 jtag_trans.data_in = 32'b10;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 check_register(top.dut.delay_sel,jtag_trans.data_out);

	 @(posedge ifc.Clk);
	 jtag_trans.op = switch_clk;
	 jtag_trans.data_in = 1;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 4 (sys_clk_switch):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = read_clk_domain;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 3 (Read clk domain):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 @(posedge ifc.Clk);
	 jtag_trans.op = switch_clk;
	 jtag_trans.data_in = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 4 (sys_clk_switch):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = read_clk_domain;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 3 (Read clk domain):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 @(posedge ifc.Clk);
	 jtag_trans.op = write_stall;
	 jtag_trans.data_in = 32'hF;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 5 (write stall):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = read_stall;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 3 (Read stall):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = advance_clk;
	 jtag_trans.data_in = 32'd6;
	 jtag_trans.addr = 32'b1010;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 6 (advance_clk):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = write_stall;
	 jtag_trans.data_in = 32'd0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 7 (write stall):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = wr_rd_delay_reg;
 	 jtag_trans.data_in = 32'd10;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 8 (wr_rd_delay_reg):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.data_out = 0;
	 jtag_trans.op = rd_rd_delay_reg;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 9 (rd_rd_delay_reg):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jtag_trans.op = read;
	 ifc.config_data_from_gc = 32'd124;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 10 (Read_data):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = wr_A050;
	 jtag_trans.done = 0;
	 jtag_trans.data_out = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 11 (A050):  Address to GC=%d, Data to GC=%d, Data FROM GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = wr_TST;
 	 jtag_trans.data_in = 32'd123;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 12 (wr_TST):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);
	 
	 @(posedge ifc.Clk);
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jtag_trans.op = rd_TST;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 13 (rd_TST):  Address to GC=%d, Data to GC=%d, Data out from GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc, jtag_trans.data_out);
	
	 @(posedge ifc.Clk);
	 jtag_trans.op = global_reset;
	 jtag_trans.data_in = 32'd8;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 14 (global_reset):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);

	 @(posedge ifc.Clk);
	 jtag_trans.op = rd_delay_sel_reg;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 15 (Read delay_sel reg):  Data from GC = %d",  
		   $time, jtag_trans.data_out);	 
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = write;
	 jtag_trans.data_in = 32'd5678;
	 jtag_trans.addr = 32'd1234;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 15 (write):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);	 
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = wr_analog_reg;
	 jtag_trans.data_in = 32'd24;
	 jtag_trans.addr = 32'd10;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 $fdisplay(fd,"%t: %m: Trans 15 (write analog reg):  Address to GC=%d, Data to GC=%d",  
		   $time, ifc.config_addr_to_gc, ifc.config_data_to_gc);	 
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = rd_analog_reg;
	 jtag_trans.addr = 32'd10;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 15 (Read analog reg):  Data from GC = %d",  
		   $time, jtag_trans.data_out);	 
	 
	 @(posedge ifc.Clk);
	 jtag_trans.op = rd_analog_reg;
	 jtag_trans.addr = 32'd14;
	 jtag_trans.data_out = 0;
	 jtag_trans.done = 0;
	 jdrv.Send(jtag_trans);
	 jtag_trans = jdrv.GetResult();
	 $fdisplay(fd,"%t: %m: Trans 15 (Read analog reg):  Data from GC = %d",  
		   $time, jtag_trans.data_out);	 
      end
   endtask // run_test



   /****************************************************************************
    * Control the simulation
    * *************************************************************************/
   initial begin
      $display("%t:\t********************Loading Arguments***********************",$time);
      init_test;
      fd = $fopen("test.log","w");
      
      $display("%t:\t*************************START*****************************",$time);
      @(negedge ifc.Reset);
      repeat (10) @(posedge ifc.Clk);
      run_test;
      repeat (10) @(posedge ifc.Clk);
      $display("%t:\t*************************FINISH****************************",$time);
      $fclose(fd);
      $finish(2);
   end
   
   
   task init_test();
      begin
	 // read user input
	 //ProcessArgs();
	 rnd0 = $random(seed); // initial the random number generator
	 
	 // init the environment
	 jdrv = new(ifc);
	 jdrv.Zero();
	
 	 //ZERO out any inputs to the DUT
	 ifc.config_data_from_gc = '0;
	 repeat (2) @(posedge ifc.Clk); 
      end
   endtask // init_test


   task check_config_write(int config_addr, int config_data);
      begin
         assert(top.dut.config_data_out == config_data);
         assert(top.dut.write == 1);
         assert(top.dut.read == 0);
         assert(top.dut.config_addr_out == config_addr);
	 while (top.dut.write == 1) begin
            //We want to make sure that on every clock edge where write is asserted,
            //the address and data are what we expect.
            assert(top.dut.config_data_out == config_data);
            assert(top.dut.write == 1);
            assert(top.dut.read == 0);
            assert(top.dut.config_addr_out == config_addr);
	    @ (posedge top.dut.clk_out);
         end
      end 
   endtask // check_config_write  
   
   task check_config_read(int config_addr);
      begin
         assert(top.dut.write == 0);
         assert(top.dut.read == 1);
         assert(top.dut.config_addr_out == config_addr);
	 while (top.dut.write == 1) begin
            //We want to make sure that on every clock edge where write is asserted,
            //the address and data are what we expect.
            assert(top.dut.write == 0);
            assert(top.dut.read == 1);
            assert(top.dut.config_addr_out == config_addr);
	    @ (posedge top.dut.clk_out);
         end
      end 
   endtask // check_config_read

   task check_register(int register, int value);
      begin
         assert(top.dut.write == 0);
         assert(top.dut.read == 0);
         assert(register == value);
      end
   endtask // check_register
 
   /****************************************************************************
    * Other Tasks:
    * *************************************************************************/
/*
   task ProcessArgs;
      begin
         // if this is a "+wave" run, it must record all signals
         if ( $test$plusargs("wave") ) begin
            //         levels  instance
            $display("time=%10t Starting Wave Capture", $time);
            $vcdpluson(0,        top);
         end
         // if this is a "+memwave" run, it must record all memories
         if ( $test$plusargs("memwave") ) begin
            //         levels  instance
            $display("time=%10t Starting Memories Capture", $time);
            CaptureMemoriesOn();
         end
         // find the seed for this run
         if ( $test$plusargs("seed") ) begin
	    $value$plusargs("seed=%d", seed);
	 end else begin
            seed = 12345;
         end
	 $display("%t: Using seed %d",$time, seed);
      end
   endtask // ProcessArgs
   
   task CaptureMemoriesOn;
      begin
         $vcdplusmemon(0,        top);
      end
   endtask // CaptureMemoriesOn
   
   task CaptureMemoriesOff;
      begin
         $vcdplusmemoff(0,        top);
      end
   endtask // CaptureMemoriesOff
  */ 
endprogram : `mname`
  
